<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Dashboard - Seat Booking</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #e3f2fd, #ede7f6, #e0f7fa);
      background-attachment: fixed;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Navbar */
    .navbar-custom {
      background: linear-gradient(135deg, #1976d2, #42a5f5);
    }
    .navbar-custom .nav-link, .navbar-custom .navbar-brand {
      color: #fff !important;
      font-weight: 500;
    }

    .container {
      background: rgba(255,255,255,0.92);
      border-radius: 16px;
      padding: 25px 35px;
      margin-top: 20px;
      box-shadow: 0px 6px 20px rgba(0,0,0,0.1);
    }

    /* Seat layout */
    .hall {
      display:flex; justify-content:center;
      margin-top:20px; gap:50px; flex-wrap:wrap;
      padding: 40px;
      border-radius: 12px;
      background: rgba(255,255,255,0.9) url("{{ url_for('static', filename='logo.png') }}") center center no-repeat;
      background-size: 180px;
      box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
    }
    .row-block { display:flex; flex-direction:column; gap:10px; }

    .seat {
      width:55px; height:60px;
      border-radius:6px;
      display:flex; align-items:center; justify-content:center;
      font-size:13px; font-weight:bold; cursor:pointer;
      flex-direction:column; padding:4px; text-align:center;
      transition: all 0.2s ease-in-out;
      color:#fff;
    }
    .seat i { font-size:18px; margin-bottom:4px; }

    .seat:hover:not(.booked):not(.blocked) {
      transform: scale(1.08);
      box-shadow: 0px 4px 10px rgba(0,0,0,0.15);
    }

    .available { background:#28a745; }
    .booked { background:#dc3545; cursor:not-allowed; }
    .blocked { background:#6c757d; cursor:not-allowed; }

    .legend span { display:inline-block; width:20px; height:20px; margin-right:5px; border-radius:4px; }

    /* Modal */
    .modal-content {
      border-radius: 12px;
      box-shadow: 0px 6px 20px rgba(0,0,0,0.2);
    }
    .modal-header {
      background: linear-gradient(135deg, #1976d2, #42a5f5);
      color: white;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
    }
    .modal-footer {
      background: #f9f9f9;
      border-bottom-left-radius: 12px;
      border-bottom-right-radius: 12px;
    }

    /* Table */
    table th {
      background: #f8f9fa;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="#">ðŸŽ“ Student Dashboard</a>
      <div class="d-flex">
        <a href="{{ url_for('profile') }}" class="btn btn-light btn-sm me-2"><i class="bi bi-person-circle"></i> Profile</a>
        <a href="{{ url_for('logout') }}" class="btn btn-danger btn-sm"><i class="bi bi-box-arrow-right"></i> Logout</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <h3 class="text-center mt-3 text-primary fw-bold">Welcome, {{ user.name }}</h3>

    {% if user.messages %}
    <div class="alert alert-warning shadow-sm mt-3">
      <h6><i class="bi bi-bell-fill"></i> Messages from Admin:</h6>
      <ul class="mb-0">
        {% for m in user.messages %}
          <li>{{ m.text }} <small>({{ m.time.strftime("%Y-%m-%d %H:%M") }})</small></li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <!-- Filters -->
    <form method="get" class="row g-3 align-items-end mt-4">
      <div class="col-md-4">
        <label class="form-label fw-bold">Filter by Seat Type</label>
        <select name="type" class="form-select shadow-sm">
          <option value="">All</option>
          {% for t in seat_types %}
            <option value="{{ t }}" {% if filter_type == t %}selected{% endif %}>{{ t }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label fw-bold">Filter by Location</label>
        <select name="location" class="form-select shadow-sm">
          <option value="">All</option>
          {% for city, halls in grouped_locations.items() %}
            <optgroup label="{{ city }}">
              {% for hall in halls %}
                <option value="{{ hall }}" {% if filter_location == hall %}selected{% endif %}>{{ hall }}</option>
              {% endfor %}
            </optgroup>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <button class="btn btn-primary shadow"><i class="bi bi-funnel-fill"></i> Apply Filters</button>
        {% if filter_type or filter_location %}
          <a class="btn btn-outline-secondary" href="{{ url_for('student_dashboard') }}">Clear</a>
        {% endif %}
      </div>
    </form>

    <!-- Seat Legend -->
    <div class="legend mb-3 mt-3 text-center">
      <span class="available"></span> Available
      <span class="booked"></span> Booked
      <span class="blocked"></span> Blocked
    </div>

    <!-- Seat Layout -->
    <div class="hall">
      {% include "seat_layout.html" %}
    </div>

    <!-- Bookings Table -->
    <h4 class="mt-5 fw-bold text-secondary">My Bookings</h4>
    <table class="table table-bordered table-sm shadow-sm">
      <thead class="table-light">
        <tr>
          <th>Seat</th>
          <th>Type</th>
          <th>Price</th>
          <th>Location</th>
          <th>Booked At</th>
          <th>Valid Till</th>
          <th>Invoice</th>
        </tr>
      </thead>
      <tbody>
      {% for b in bookings %}
        {% set seat = seats|selectattr("id", "equalto", b.seat_id)|first %}
        <tr>
          <td>{{ b.seat_id }}</td>
          <td>{{ seat.type if seat else "" }}</td>
          <td>â‚¹{{ b.amount }}</td>
          <td>{{ seat.location if seat else "" }}</td>
          <td>{{ b.created_at.strftime("%Y-%m-%d %H:%M") }}</td>
          <td>{{ b.valid_till.strftime("%Y-%m-%d") }}</td>
          <td><a href="{{ url_for('invoice', bid=b.id) }}" target="_blank" class="btn btn-sm btn-primary">View</a></td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Booking Modal -->
  <div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="bookingForm">
          <div class="modal-header">
            <h5 class="modal-title">Book Seat</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="seat_id" id="seat_id">
            <div class="mb-2"><label>Seat Number</label><input type="text" class="form-control" id="seat_number" readonly></div>
            <div class="mb-2"><label>Seat Type</label><input type="text" class="form-control" id="seat_type" readonly></div>
            <div class="mb-2"><label>Price</label><input type="text" class="form-control" id="seat_price" readonly></div>
            <div class="mb-2"><label>Location</label><input type="text" class="form-control" id="seat_location" readonly></div>

            <hr>
            <div class="mb-2"><label>Your Name</label><input type="text" class="form-control" name="name" value="{{ user.name }}" required></div>
            <div class="mb-2"><label>Contact Number</label><input type="text" class="form-control" name="contact" value="{{ user.mobile }}" required></div>
            <div class="mb-2"><label>Email</label><input type="email" class="form-control" name="email" value="{{ user.email }}" required></div>
            <div class="mb-2"><label>Valid Till</label><input type="date" class="form-control" name="valid_till" required></div>
            <div class="mb-2">
              <label>Upload Aadhaar Card</label>
              <input type="file" class="form-control" name="aadhaar" accept=".pdf,.jpg,.jpeg,.png" required>
            </div>
            <div class="mb-2">
              <label>Upload Passport Size Photo</label>
              <input type="file" class="form-control" name="photo" accept=".jpg,.jpeg,.png" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Confirm Booking</button>
          </div>
        </form>
      </div>
    </div>
  </div>

<script>
  $(document).on("click", ".seat.available", function() {
    $("#seat_id").val($(this).data("id"));
    $("#seat_number").val($(this).data("number"));
    $("#seat_type").val($(this).data("type"));
    $("#seat_price").val($(this).data("price"));
    $("#seat_location").val($(this).data("location"));
    $("#bookingModal").modal("show");
  });

  $("#bookingForm").on("submit", function(e) {
    e.preventDefault();
    var formData = new FormData(this);
    $.ajax({
      url: "/book",
      type: "POST",
      data: formData,
      processData: false,
      contentType: false,
      success: function(res) {
        if (res.success) {
          alert("Seat booked successfully!");
          location.reload();
        } else {
          alert(res.message || "Booking failed");
        }
      }
    });
  });
</script>

</body>
</html>
